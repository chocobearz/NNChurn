---
title: "Churn analysis with neuralnet"
author: "Paige, Vicky, and Jackie"
date: '2019-11-10'
output: 
  prettydoc::html_pretty:
  theme : cayman
  highlight : github
  math: katex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Info:
```{r}
# Link to the article that informed this code
# https://www.datacamp.com/community/tutorials/neural-network-models-r
```

Example
```{r, eval = F}
#library(neuralnet)
#library(dplyr)

# creating training data set
TKS1 = c(20, 10, 30, 20, 80, 30)
CSS1 = c(90, 20, 40, 50, 50, 80)
Placed1 = c(1, 0, 0, 0, 1, 1)

# Here, you will combine multiple columns or features into a single set of data
df1 = data.frame(TKS1, CSS1, Placed1)

# Fitting the neural network
nn1 <- neuralnet(Placed1 ~ TKS1 + CSS1, data = df1, hidden = 3, act.fct = "logistic", linear.output = F)

# Plotting the neural network
plot(nn1)

# Creating a test set
TKS1 = c(30, 40, 85)
CSS1 = c(85, 50, 40)
test1 <- data.frame(TKS1, CSS1)

# Predict 'Placed1'
Predict1 = neuralnet::compute(nn1, test1)
Predict1$net.result

# Converting probabilities into binary placed or not
prob1 <- Predict1$net.result
(pred1 <- ifelse(prob1 > 0.5, yes = 1, no = 0))
```

**Trying neural networks with churn data**



## Fitting the model
```{r}
m <- model.matrix( 
  ~ . -customerid, 
  data = cd1
)

r <- neuralnet(churnYes ~ genderMale + seniorcitizenYes + partnerYes + dependentsYes + tenure +phoneserviceYes + multiplelinesYes + internetservicefiberOptic + internetserviceNo + onlinesecurityYes + onlinebackupYes + deviceprotectionYes + techsupportYes + streamingtvYes + streamingmoviesYes + contractoneYear + contracttwoYear + paperlessbillingYes + paymentmethodAcheck,
  data=m, hidden=10, threshold=0.01
)

plot(r)
```

```{r}

# Fitting the neural network
full_formula <- as.formula(paste("churn ~ ", paste(colnames(cd1)[c(2:5, 7:17, 19, 22:25)], collapse = " + ")))

# Only using monthlycharges and tenure columns for now
# Using full_formula as the formula gives an error stating that everything has
# to be numeric/vector/something else
nn1 <- neuralnet(churn ~ monthlycharges + tenure, data = cd1, hidden = 3, act.fct = "logistic", linear.output = F)

plot(nn1)
```

## Using effect plots to detemine which regressors to use for logistic reg.
```{r, fig.width = 10, fig.height = 8}
# Making effect plots and omitting certain variables
# Splitting into three plots so that it is more readable
# Create the three formulas
formula_1 <- as.formula(paste("churn ~ ", paste(colnames(cd1)[c(2:5, 7:11)], collapse = " + ")))
formula_2 <- as.formula(paste("churn ~ ", paste(colnames(cd1)[c(12:17, 19, 22, 23)], collapse = " + ")))
formula_3 <- as.formula(paste("churn ~ ", paste(colnames(cd1)[c(24, 25)], collapse = " + ")))
# Creating the logistic regression models
lrfit1 <- glm(formula_1, cd1, family = binomial(link = "logit"))
lrfit2 <- glm(formula_2, cd1, family = binomial(link = "logit"))
lrfit3 <- glm(formula_3, cd1, family = binomial(link = "logit"))
# Making the plots; third plot is in the next code chunk
plot(allEffects(lrfit1), type = "response")
plot(allEffects(lrfit2), type = "response")
#plot(allEffects(lrfit3), type = "response")
```

```{r, fig.width = 8, fig.height = 4}
plot(allEffects(lrfit3), type = "response")
```






